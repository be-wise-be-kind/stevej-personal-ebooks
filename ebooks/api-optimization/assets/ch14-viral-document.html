<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Document Scaling: Before and After</title>
    <style>
        body {
            font-family: Liberation Sans, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .diagram-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            max-width: 100%;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="diagram-container">
        <svg viewBox="0 0 900 580" xmlns="http://www.w3.org/2000/svg">
            <!-- Background -->
            <rect width="900" height="580" fill="white"/>

            <!-- Title -->
            <text x="450" y="30" text-anchor="middle" style="font-size: 18px; font-weight: 600; fill: #1e293b;" font-family="Liberation Sans, Arial, sans-serif">Scaling for Viral Documents</text>

            <!-- Arrow markers -->
            <defs>
                <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626"/>
                </marker>
                <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
                </marker>
                <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                </marker>
                <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
                </marker>
                <marker id="arrowGray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
                </marker>
            </defs>

            <!-- BEFORE Section -->
            <rect x="30" y="50" width="400" height="240" fill="#fef2f2" rx="8" stroke="#fca5a5" stroke-width="2"/>
            <text x="230" y="75" text-anchor="middle" style="font-size: 14px; font-weight: 600; fill: #991b1b;" font-family="Liberation Sans, Arial, sans-serif">BEFORE: Random Load Balancing</text>

            <!-- Before: Users cluster -->
            <text x="70" y="100" text-anchor="middle" style="font-size: 10px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">4,500 users</text>
            <rect x="45" y="110" width="50" height="25" fill="#e0f2fe" rx="3" stroke="#0284c7" stroke-width="1"/>
            <rect x="45" y="140" width="50" height="25" fill="#e0f2fe" rx="3" stroke="#0284c7" stroke-width="1"/>
            <rect x="45" y="170" width="50" height="25" fill="#e0f2fe" rx="3" stroke="#0284c7" stroke-width="1"/>
            <text x="70" y="210" text-anchor="middle" style="font-size: 9px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">...</text>

            <!-- Before: Load Balancer -->
            <rect x="130" y="130" width="70" height="50" fill="#64748b" rx="4"/>
            <text x="165" y="155" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Load</text>
            <text x="165" y="168" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Balancer</text>

            <!-- Before: Sync Instances -->
            <!-- Instance 1 - OVERLOADED -->
            <rect x="240" y="95" width="80" height="55" fill="#dc2626" rx="6"/>
            <text x="280" y="115" text-anchor="middle" style="font-size: 10px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #1</text>
            <text x="280" y="130" text-anchor="middle" style="font-size: 8px; fill: #fecaca;" font-family="Liberation Sans, Arial, sans-serif">4,500 conns</text>
            <text x="280" y="143" text-anchor="middle" style="font-size: 8px; fill: #fecaca;" font-family="Liberation Sans, Arial, sans-serif">98% memory</text>

            <!-- Instance 2 - Idle -->
            <rect x="240" y="160" width="80" height="45" fill="#22c55e" rx="6"/>
            <text x="280" y="180" text-anchor="middle" style="font-size: 10px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #2</text>
            <text x="280" y="195" text-anchor="middle" style="font-size: 8px; fill: #bbf7d0;" font-family="Liberation Sans, Arial, sans-serif">50 conns (30%)</text>

            <!-- Instance 3 - Idle -->
            <rect x="240" y="215" width="80" height="45" fill="#22c55e" rx="6"/>
            <text x="280" y="235" text-anchor="middle" style="font-size: 10px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #3</text>
            <text x="280" y="250" text-anchor="middle" style="font-size: 8px; fill: #bbf7d0;" font-family="Liberation Sans, Arial, sans-serif">50 conns (30%)</text>

            <!-- Before: Redis -->
            <rect x="355" y="140" width="60" height="40" fill="#dc2626" rx="4"/>
            <text x="385" y="160" text-anchor="middle" style="font-size: 10px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Redis</text>
            <text x="385" y="173" text-anchor="middle" style="font-size: 7px; fill: #fecaca;" font-family="Liberation Sans, Arial, sans-serif">Pub/Sub</text>

            <!-- Before: Arrows -->
            <line x1="100" y1="135" x2="125" y2="145" stroke="#dc2626" stroke-width="2" marker-end="url(#arrowRed)"/>
            <line x1="100" y1="155" x2="125" y2="155" stroke="#dc2626" stroke-width="2" marker-end="url(#arrowRed)"/>
            <line x1="100" y1="175" x2="125" y2="165" stroke="#dc2626" stroke-width="2" marker-end="url(#arrowRed)"/>

            <!-- Thick arrow to overloaded instance -->
            <line x1="205" y1="145" x2="235" y2="122" stroke="#dc2626" stroke-width="4" marker-end="url(#arrowRed)"/>
            <line x1="205" y1="155" x2="235" y2="182" stroke="#22c55e" stroke-width="1" marker-end="url(#arrowGreen)"/>
            <line x1="205" y1="165" x2="235" y2="237" stroke="#22c55e" stroke-width="1" marker-end="url(#arrowGreen)"/>

            <!-- Before: Problem callouts -->
            <rect x="50" y="235" width="170" height="45" fill="#fef2f2" rx="4" stroke="#fca5a5" stroke-width="1"/>
            <text x="135" y="252" text-anchor="middle" style="font-size: 9px; fill: #991b1b; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Problems:</text>
            <text x="135" y="265" text-anchor="middle" style="font-size: 8px; fill: #b91c1c;" font-family="Liberation Sans, Arial, sans-serif">• Hot document on single instance</text>
            <text x="135" y="276" text-anchor="middle" style="font-size: 8px; fill: #b91c1c;" font-family="Liberation Sans, Arial, sans-serif">• OOM crash → mass disconnect</text>

            <!-- AFTER Section -->
            <rect x="470" y="50" width="400" height="240" fill="#f0fdf4" rx="8" stroke="#86efac" stroke-width="2"/>
            <text x="670" y="75" text-anchor="middle" style="font-size: 14px; font-weight: 600; fill: #166534;" font-family="Liberation Sans, Arial, sans-serif">AFTER: Document-Based Sharding</text>

            <!-- After: Users split -->
            <text x="510" y="100" text-anchor="middle" style="font-size: 10px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">4,500 users</text>
            <rect x="485" y="110" width="50" height="20" fill="#e0f2fe" rx="3" stroke="#0284c7" stroke-width="1"/>
            <rect x="485" y="135" width="50" height="20" fill="#e0f2fe" rx="3" stroke="#0284c7" stroke-width="1"/>
            <rect x="485" y="160" width="50" height="20" fill="#fef3c7" rx="3" stroke="#f59e0b" stroke-width="1"/>
            <text x="510" y="200" text-anchor="middle" style="font-size: 8px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">500 editors</text>
            <text x="510" y="212" text-anchor="middle" style="font-size: 8px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">4,000 viewers</text>

            <!-- After: Smart Router -->
            <rect x="560" y="125" width="70" height="55" fill="#8b5cf6" rx="4"/>
            <text x="595" y="145" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Document</text>
            <text x="595" y="158" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Router</text>
            <text x="595" y="173" text-anchor="middle" style="font-size: 7px; fill: #ddd6fe;" font-family="Liberation Sans, Arial, sans-serif">(by doc ID)</text>

            <!-- After: Shard Group -->
            <rect x="660" y="90" width="190" height="130" fill="#dcfce7" rx="6" stroke="#86efac" stroke-width="1" stroke-dasharray="4,2"/>
            <text x="755" y="108" text-anchor="middle" style="font-size: 9px; fill: #166534; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Document Shard Group</text>

            <!-- Instance 1 -->
            <rect x="670" y="120" width="70" height="40" fill="#22c55e" rx="4"/>
            <text x="705" y="140" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #1</text>
            <text x="705" y="153" text-anchor="middle" style="font-size: 7px; fill: #bbf7d0;" font-family="Liberation Sans, Arial, sans-serif">1,500 conns</text>

            <!-- Instance 2 -->
            <rect x="750" y="120" width="70" height="40" fill="#22c55e" rx="4"/>
            <text x="785" y="140" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #2</text>
            <text x="785" y="153" text-anchor="middle" style="font-size: 7px; fill: #bbf7d0;" font-family="Liberation Sans, Arial, sans-serif">1,500 conns</text>

            <!-- Instance 3 -->
            <rect x="710" y="170" width="70" height="40" fill="#22c55e" rx="4"/>
            <text x="745" y="190" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Sync #3</text>
            <text x="745" y="203" text-anchor="middle" style="font-size: 7px; fill: #bbf7d0;" font-family="Liberation Sans, Arial, sans-serif">1,500 conns</text>

            <!-- Direct coordination arrow -->
            <path d="M740,145 L750,145" fill="none" stroke="#166534" stroke-width="2"/>
            <path d="M745,160 L745,170" fill="none" stroke="#166534" stroke-width="2"/>
            <text x="755" y="235" text-anchor="middle" style="font-size: 7px; fill: #166534;" font-family="Liberation Sans, Arial, sans-serif">Direct coordination</text>
            <text x="755" y="245" text-anchor="middle" style="font-size: 7px; fill: #166534;" font-family="Liberation Sans, Arial, sans-serif">(no Redis fan-out)</text>

            <!-- After: Arrows -->
            <line x1="540" y1="130" x2="555" y2="140" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>
            <line x1="540" y1="145" x2="555" y2="152" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>
            <line x1="540" y1="170" x2="555" y2="165" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arrowGray)"/>

            <line x1="635" y1="140" x2="665" y2="135" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
            <line x1="635" y1="152" x2="665" y2="145" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
            <line x1="635" y1="165" x2="665" y2="185" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>

            <!-- After: Benefits callouts -->
            <rect x="490" y="235" width="170" height="45" fill="#f0fdf4" rx="4" stroke="#86efac" stroke-width="1"/>
            <text x="575" y="252" text-anchor="middle" style="font-size: 9px; fill: #166534; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Solutions:</text>
            <text x="575" y="265" text-anchor="middle" style="font-size: 8px; fill: #15803d;" font-family="Liberation Sans, Arial, sans-serif">• Load distributed across shard</text>
            <text x="575" y="276" text-anchor="middle" style="font-size: 8px; fill: #15803d;" font-family="Liberation Sans, Arial, sans-serif">• Graceful viewer mode overflow</text>

            <!-- Presence Throttling Section -->
            <rect x="30" y="310" width="400" height="120" fill="#f8fafc" rx="8" stroke="#e2e8f0" stroke-width="2"/>
            <text x="230" y="335" text-anchor="middle" style="font-size: 12px; font-weight: 600; fill: #374151;" font-family="Liberation Sans, Arial, sans-serif">Presence Throttling</text>

            <!-- Before presence -->
            <rect x="50" y="350" width="160" height="60" fill="#fef2f2" rx="4" stroke="#fca5a5" stroke-width="1"/>
            <text x="130" y="370" text-anchor="middle" style="font-size: 9px; fill: #991b1b; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Before: All cursors</text>
            <text x="130" y="385" text-anchor="middle" style="font-size: 8px; fill: #b91c1c;" font-family="Liberation Sans, Arial, sans-serif">4,500 users × 10 updates/sec</text>
            <text x="130" y="400" text-anchor="middle" style="font-size: 10px; fill: #dc2626; font-weight: 700;" font-family="Liberation Sans, Arial, sans-serif">= 45,000 msgs/sec</text>

            <!-- After presence -->
            <rect x="250" y="350" width="160" height="60" fill="#f0fdf4" rx="4" stroke="#86efac" stroke-width="1"/>
            <text x="330" y="370" text-anchor="middle" style="font-size: 9px; fill: #166534; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">After: Sampled (50 cursors)</text>
            <text x="330" y="385" text-anchor="middle" style="font-size: 8px; fill: #15803d;" font-family="Liberation Sans, Arial, sans-serif">50 samples × 2 updates/sec</text>
            <text x="330" y="400" text-anchor="middle" style="font-size: 10px; fill: #22c55e; font-weight: 700;" font-family="Liberation Sans, Arial, sans-serif">= 100 msgs/sec</text>

            <!-- Arrow between -->
            <path d="M215,380 L245,380" fill="none" stroke="#64748b" stroke-width="2" marker-end="url(#arrowGray)"/>
            <text x="230" y="372" text-anchor="middle" style="font-size: 8px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">99.8%</text>
            <text x="230" y="395" text-anchor="middle" style="font-size: 8px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">reduction</text>

            <!-- Connection Limits Section -->
            <rect x="470" y="310" width="400" height="120" fill="#f8fafc" rx="8" stroke="#e2e8f0" stroke-width="2"/>
            <text x="670" y="335" text-anchor="middle" style="font-size: 12px; font-weight: 600; fill: #374151;" font-family="Liberation Sans, Arial, sans-serif">Graceful Degradation</text>

            <!-- Connection tiers -->
            <rect x="490" y="350" width="120" height="25" fill="#3b82f6" rx="3"/>
            <text x="550" y="367" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">500 Active Editors</text>

            <rect x="490" y="380" width="120" height="25" fill="#f59e0b" rx="3"/>
            <text x="550" y="397" text-anchor="middle" style="font-size: 9px; fill: white; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">4,000 Viewers</text>

            <!-- Descriptions -->
            <text x="630" y="365" style="font-size: 8px; fill: #1e40af;" font-family="Liberation Sans, Arial, sans-serif">Full real-time sync</text>
            <text x="630" y="395" style="font-size: 8px; fill: #92400e;" font-family="Liberation Sans, Arial, sans-serif">Periodic updates (2/sec)</text>

            <!-- UI message -->
            <rect x="720" y="355" width="135" height="50" fill="#fef3c7" rx="4" stroke="#f59e0b" stroke-width="1"/>
            <text x="787" y="372" text-anchor="middle" style="font-size: 8px; fill: #92400e; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">User sees:</text>
            <text x="787" y="385" text-anchor="middle" style="font-size: 7px; fill: #a16207; font-style: italic;" font-family="Liberation Sans, Arial, sans-serif">"4,500 people viewing"</text>
            <text x="787" y="397" text-anchor="middle" style="font-size: 7px; fill: #a16207; font-style: italic;" font-family="Liberation Sans, Arial, sans-serif">"View-only mode enabled"</text>

            <!-- Bottom summary -->
            <rect x="30" y="450" width="840" height="110" fill="#f1f5f9" rx="6"/>
            <text x="450" y="475" text-anchor="middle" style="font-size: 12px; fill: #374151; font-weight: 600;" font-family="Liberation Sans, Arial, sans-serif">Key Insight: Stateful Services Need Different Scaling Strategies</text>

            <text x="225" y="505" text-anchor="middle" style="font-size: 10px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">Stateless APIs:</text>
            <text x="225" y="520" text-anchor="middle" style="font-size: 9px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">Add instances, distribute randomly</text>
            <text x="225" y="535" text-anchor="middle" style="font-size: 9px; fill: #64748b;" font-family="Liberation Sans, Arial, sans-serif">Any instance handles any request</text>

            <text x="450" y="520" text-anchor="middle" style="font-size: 20px; fill: #94a3b8;" font-family="Liberation Sans, Arial, sans-serif">≠</text>

            <text x="675" y="505" text-anchor="middle" style="font-size: 10px; fill: #374151; font-weight: 500;" font-family="Liberation Sans, Arial, sans-serif">Stateful WebSockets:</text>
            <text x="675" y="520" text-anchor="middle" style="font-size: 9px; fill: #374151;" font-family="Liberation Sans, Arial, sans-serif">Shard by entity (document), not randomly</text>
            <text x="675" y="535" text-anchor="middle" style="font-size: 9px; fill: #374151;" font-family="Liberation Sans, Arial, sans-serif">Account for hot spots + graceful degradation</text>
        </svg>
    </div>
</body>
</html>
