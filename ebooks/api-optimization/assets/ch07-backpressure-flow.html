<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backpressure Flow Diagram</title>
    <style>
        body {
            font-family: Liberation Sans, Arial, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .diagram-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            max-width: 100%;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="diagram-container">
        
        <svg viewBox="0 0 950 635" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="normalGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="warningGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="dangerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="producerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="queueGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="consumerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                </linearGradient>
                <marker id="arrowGreen" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L6,3 z" fill="#10b981"/>
                </marker>
                <marker id="arrowRed" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L6,3 z" fill="#ef4444"/>
                </marker>
                <marker id="arrowBlue" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L6,3 z" fill="#3b82f6"/>
                </marker>
                <marker id="arrowOrange" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L6,3 z" fill="#f59e0b"/>
                </marker>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                </filter>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>

            <!-- Title for Flow States -->
            <text x="475" y="35" font-family="inherit" font-size="16" font-weight="600" fill="#1e293b" text-anchor="middle" >System State Progression</text>

            <!-- STATE 1: Normal -->
            <rect x="30" y="55" width="200" height="195" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
            <rect x="30" y="55" width="200" height="35" rx="10" fill="url(#normalGrad)"/>
            <text x="130" y="78" font-family="inherit" font-size="13" font-weight="600" fill="white" text-anchor="middle" >1. Normal State</text>

            <!-- Normal - Components -->
            <rect x="50" y="110" width="60" height="35" rx="4" fill="url(#producerGrad)" filter="url(#shadow)"/>
            <text x="80" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Producer</text>
            <text x="80" y="158" font-family="inherit" font-size="10" fill="#10b981" >100/s</text>

            <!-- Normal Queue -->
            <rect x="90" y="180" width="80" height="50" rx="4" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1"/>
            <rect x="95" y="195" width="10" height="30" rx="2" fill="#10b981"/>
            <rect x="108" y="195" width="10" height="30" rx="2" fill="#10b981"/>
            <rect x="121" y="195" width="10" height="30" rx="2" fill="#10b981" opacity="0.5"/>
            <text x="130" y="178" font-family="inherit" font-size="10" fill="#64748b" text-anchor="middle" >Queue: 30%</text>

            <rect x="150" y="110" width="60" height="35" rx="4" fill="url(#consumerGrad)" filter="url(#shadow)"/>
            <text x="180" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Consumer</text>
            <text x="180" y="158" font-family="inherit" font-size="10" fill="#10b981" >100/s</text>

            <!-- Equal flow arrows -->
            <line x1="95" y1="127" x2="145" y2="127" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>

            <!-- STATE 2: Overload Building -->
            <rect x="260" y="55" width="200" height="195" rx="10" fill="#fef3c7" stroke="#fde047" stroke-width="2"/>
            <rect x="260" y="55" width="200" height="35" rx="10" fill="url(#warningGrad)"/>
            <text x="360" y="78" font-family="inherit" font-size="13" font-weight="600" fill="white" text-anchor="middle" >2. Overload Building</text>

            <!-- Overload - Components -->
            <rect x="280" y="110" width="60" height="35" rx="4" fill="url(#producerGrad)" filter="url(#shadow)"/>
            <text x="310" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Producer</text>
            <text x="310" y="158" font-family="inherit" font-size="10" fill="#f59e0b" font-weight="600" >200/s</text>

            <!-- Overload Queue -->
            <rect x="320" y="180" width="80" height="50" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
            <rect x="325" y="190" width="10" height="35" rx="2" fill="#f59e0b"/>
            <rect x="338" y="190" width="10" height="35" rx="2" fill="#f59e0b"/>
            <rect x="351" y="190" width="10" height="35" rx="2" fill="#f59e0b"/>
            <rect x="364" y="190" width="10" height="35" rx="2" fill="#f59e0b"/>
            <rect x="377" y="190" width="10" height="35" rx="2" fill="#f59e0b" opacity="0.6"/>
            <text x="360" y="178" font-family="inherit" font-size="10" fill="#d97706" text-anchor="middle" font-weight="600" >Queue: 80%</text>

            <rect x="380" y="110" width="60" height="35" rx="4" fill="url(#consumerGrad)" filter="url(#shadow)"/>
            <text x="410" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Consumer</text>
            <text x="410" y="158" font-family="inherit" font-size="10" fill="#64748b" >100/s</text>

            <!-- Unequal flow -->
            <path d="M 325 127 L 375 127" stroke="#f59e0b" stroke-width="4" marker-end="url(#arrowOrange)"/>

            <!-- Rising indicator -->
            <path d="M 340 235 L 360 215 L 380 235" stroke="#ef4444" stroke-width="2" fill="none"/>
            <text x="360" y="247" font-family="inherit" font-size="10" fill="#ef4444" text-anchor="middle" >Rising</text>

            <!-- STATE 3: Backpressure Signal -->
            <rect x="490" y="55" width="200" height="195" rx="10" fill="#fef2f2" stroke="#fecaca" stroke-width="2"/>
            <rect x="490" y="55" width="200" height="35" rx="10" fill="url(#dangerGrad)"/>
            <text x="590" y="78" font-family="inherit" font-size="13" font-weight="600" fill="white" text-anchor="middle" >3. Backpressure Signal</text>

            <!-- Signal - Components -->
            <rect x="510" y="110" width="60" height="35" rx="4" fill="url(#producerGrad)" filter="url(#shadow)"/>
            <text x="540" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Producer</text>

            <!-- Alert signal -->
            <circle cx="545" cy="105" r="8" fill="#ef4444" filter="url(#glow)"/>
            <text x="545" y="109" font-family="inherit" font-size="10" fill="white" text-anchor="middle" font-weight="bold" >!</text>
            <text x="590" y="103" font-family="inherit" font-size="10" fill="#dc2626" text-anchor="middle" >SLOW DOWN</text>

            <!-- Full Queue -->
            <rect x="550" y="180" width="80" height="50" rx="4" fill="#fef2f2" stroke="#ef4444" stroke-width="2"/>
            <rect x="555" y="187" width="10" height="38" rx="2" fill="#ef4444"/>
            <rect x="568" y="187" width="10" height="38" rx="2" fill="#ef4444"/>
            <rect x="581" y="187" width="10" height="38" rx="2" fill="#ef4444"/>
            <rect x="594" y="187" width="10" height="38" rx="2" fill="#ef4444"/>
            <rect x="607" y="187" width="10" height="38" rx="2" fill="#ef4444"/>
            <text x="590" y="178" font-family="inherit" font-size="10" fill="#dc2626" text-anchor="middle" font-weight="600" >Queue: 100%</text>

            <rect x="610" y="110" width="60" height="35" rx="4" fill="url(#consumerGrad)" filter="url(#shadow)"/>
            <text x="640" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Consumer</text>
            <text x="640" y="158" font-family="inherit" font-size="10" fill="#64748b" >100/s</text>

            <!-- Backpressure arrow (reverse) -->
            <line x1="605" y1="127" x2="575" y2="127" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowRed)" stroke-dasharray="5,3"/>

            <!-- STATE 4: Producer Throttled -->
            <rect x="720" y="55" width="200" height="195" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
            <rect x="720" y="55" width="200" height="35" rx="10" fill="url(#normalGrad)"/>
            <text x="820" y="78" font-family="inherit" font-size="13" font-weight="600" fill="white" text-anchor="middle" >4. Stabilized</text>

            <!-- Stabilized - Components -->
            <rect x="740" y="110" width="60" height="35" rx="4" fill="url(#producerGrad)" filter="url(#shadow)"/>
            <text x="770" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Producer</text>
            <text x="770" y="158" font-family="inherit" font-size="10" fill="#10b981" >50/s</text>
            <text x="770" y="170" font-family="inherit" font-size="10" fill="#64748b" >(throttled)</text>

            <!-- Draining Queue -->
            <rect x="780" y="180" width="80" height="50" rx="4" fill="#f0fdf4" stroke="#10b981" stroke-width="1"/>
            <rect x="785" y="195" width="10" height="30" rx="2" fill="#10b981"/>
            <rect x="798" y="195" width="10" height="30" rx="2" fill="#10b981"/>
            <rect x="811" y="195" width="10" height="30" rx="2" fill="#10b981"/>
            <rect x="824" y="195" width="10" height="30" rx="2" fill="#10b981" opacity="0.4"/>
            <text x="820" y="178" font-family="inherit" font-size="10" fill="#10b981" text-anchor="middle" >Queue: 60%</text>

            <rect x="840" y="110" width="60" height="35" rx="4" fill="url(#consumerGrad)" filter="url(#shadow)"/>
            <text x="870" y="132" font-family="inherit" font-size="10" font-weight="500" fill="white" text-anchor="middle" >Consumer</text>
            <text x="870" y="158" font-family="inherit" font-size="10" fill="#10b981" >100/s</text>

            <!-- Balanced flow -->
            <line x1="785" y1="127" x2="835" y2="127" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>

            <!-- Falling indicator -->
            <path d="M 800 215 L 820 235 L 840 215" stroke="#10b981" stroke-width="2" fill="none"/>
            <text x="820" y="247" font-family="inherit" font-size="10" fill="#10b981" text-anchor="middle" >Draining</text>

            <!-- Flow Arrows Between States -->
            <line x1="232" y1="152" x2="255" y2="152" stroke="#64748b" stroke-width="2" marker-end="url(#arrowBlue)"/>
            <line x1="462" y1="152" x2="485" y2="152" stroke="#64748b" stroke-width="2" marker-end="url(#arrowBlue)"/>
            <line x1="692" y1="152" x2="715" y2="152" stroke="#64748b" stroke-width="2" marker-end="url(#arrowBlue)"/>

            <!-- Metrics Section -->
            <rect x="30" y="285" width="890" height="310" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
            <text x="475" y="315" font-family="inherit" font-size="14" font-weight="600" fill="#1e293b" text-anchor="middle" >Key Backpressure Metrics to Monitor</text>

            <!-- Metric Cards -->
            <!-- Queue Depth -->
            <rect x="60" y="335" width="160" height="125" rx="6" fill="white" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
            <rect x="60" y="335" width="160" height="32" rx="6" fill="#8b5cf6"/>
            <text x="140" y="357" font-family="inherit" font-size="11" font-weight="500" fill="white" text-anchor="middle" >Queue Depth</text>
            <text x="140" y="387" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >Current messages</text>
            <text x="140" y="407" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >in the queue</text>
            <text x="140" y="445" font-family="inherit" font-size="20" font-weight="600" fill="#8b5cf6" text-anchor="middle" >1,247</text>

            <!-- Consumer Lag -->
            <rect x="240" y="335" width="160" height="125" rx="6" fill="white" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
            <rect x="240" y="335" width="160" height="32" rx="6" fill="#06b6d4"/>
            <text x="320" y="357" font-family="inherit" font-size="11" font-weight="500" fill="white" text-anchor="middle" >Consumer Lag</text>
            <text x="320" y="387" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >Messages behind</text>
            <text x="320" y="407" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >latest offset</text>
            <text x="320" y="445" font-family="inherit" font-size="20" font-weight="600" fill="#06b6d4" text-anchor="middle" >523</text>

            <!-- Oldest Message Age -->
            <rect x="420" y="335" width="160" height="125" rx="6" fill="white" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
            <rect x="420" y="335" width="160" height="32" rx="6" fill="#f59e0b"/>
            <text x="500" y="357" font-family="inherit" font-size="11" font-weight="500" fill="white" text-anchor="middle" >Oldest Message</text>
            <text x="500" y="387" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >Age of oldest</text>
            <text x="500" y="407" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >unprocessed msg</text>
            <text x="500" y="445" font-family="inherit" font-size="20" font-weight="600" fill="#f59e0b" text-anchor="middle" >45s</text>

            <!-- Processing Rate -->
            <rect x="600" y="335" width="160" height="125" rx="6" fill="white" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
            <rect x="600" y="335" width="160" height="32" rx="6" fill="#10b981"/>
            <text x="680" y="357" font-family="inherit" font-size="11" font-weight="500" fill="white" text-anchor="middle" >Processing Rate</text>
            <text x="680" y="387" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >Messages processed</text>
            <text x="680" y="407" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >per second</text>
            <text x="680" y="445" font-family="inherit" font-size="20" font-weight="600" fill="#10b981" text-anchor="middle" >98/s</text>

            <!-- Throttle Events -->
            <rect x="780" y="335" width="120" height="125" rx="6" fill="white" stroke="#cbd5e1" stroke-width="1" filter="url(#shadow)"/>
            <rect x="780" y="335" width="120" height="32" rx="6" fill="#ef4444"/>
            <text x="840" y="357" font-family="inherit" font-size="11" font-weight="500" fill="white" text-anchor="middle" >Throttle Events</text>
            <text x="840" y="387" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >Producer</text>
            <text x="840" y="407" font-family="inherit" font-size="10" fill="#475569" text-anchor="middle" >slowdowns</text>
            <text x="840" y="445" font-family="inherit" font-size="20" font-weight="600" fill="#ef4444" text-anchor="middle" >12</text>

            <!-- Strategies Section -->
            <text x="475" y="490" font-family="inherit" font-size="12" font-weight="600" fill="#1e293b" text-anchor="middle" >Backpressure Strategies</text>

            <rect x="60" y="510" width="200" height="65" rx="6" fill="#fef2f2" stroke="#fecaca" stroke-width="1"/>
            <text x="160" y="537" font-family="inherit" font-size="11" font-weight="500" fill="#dc2626" text-anchor="middle" >Block Producers</text>
            <text x="160" y="559" font-family="inherit" font-size="10" fill="#64748b" text-anchor="middle" >Wait until space available</text>

            <rect x="280" y="510" width="200" height="65" rx="6" fill="#fef3c7" stroke="#fde047" stroke-width="1"/>
            <text x="380" y="537" font-family="inherit" font-size="11" font-weight="500" fill="#d97706" text-anchor="middle" >Reject Messages</text>
            <text x="380" y="559" font-family="inherit" font-size="10" fill="#64748b" text-anchor="middle" >Return errors, client retries</text>

            <rect x="500" y="510" width="200" height="65" rx="6" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
            <text x="600" y="537" font-family="inherit" font-size="11" font-weight="500" fill="#059669" text-anchor="middle" >Dynamic Rate Limiting</text>
            <text x="600" y="559" font-family="inherit" font-size="10" fill="#64748b" text-anchor="middle" >Adjust rate based on signals</text>

            <rect x="720" y="510" width="180" height="65" rx="6" fill="#eff6ff" stroke="#bfdbfe" stroke-width="1"/>
            <text x="810" y="537" font-family="inherit" font-size="11" font-weight="500" fill="#2563eb" text-anchor="middle" >Scale Consumers</text>
            <text x="810" y="559" font-family="inherit" font-size="10" fill="#64748b" text-anchor="middle" >Auto-scale on queue depth</text>
        </svg>
    </div>
</body>
</html>
