<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLoader Execution Flow</title>
    <style>
        body {
            font-family: Liberation Sans, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .diagram-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            max-width: 100%;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="diagram-container">
        <svg viewBox="0 0 950 540" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <!-- Gradients -->
                <linearGradient id="resolverGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="loaderGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="dbGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="successGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                </linearGradient>
                <!-- Arrow marker -->
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
                </marker>
                <marker id="arrowheadPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
                </marker>
                <marker id="arrowheadBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                </marker>
                <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
                </marker>
                <!-- Shadow -->
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                </filter>
            </defs>

            <!-- Background -->
            <rect width="950" height="540" fill="#f8fafc" rx="8"/>

            <!-- Title -->
            <text x="475" y="35" text-anchor="middle" font-size="22" font-weight="600" fill="#1e293b" font-family="Liberation Sans, Arial, sans-serif">
                DataLoader Execution Flow
            </text>
            <text x="475" y="55" text-anchor="middle" font-size="13" fill="#64748b" font-family="Liberation Sans, Arial, sans-serif">
                Batching N+1 queries into a single database call
            </text>

            <!-- Phase labels -->
            <text x="130" y="90" text-anchor="middle" font-size="12" font-weight="600" fill="#64748b" font-family="Liberation Sans, Arial, sans-serif">RESOLVERS</text>
            <text x="380" y="90" text-anchor="middle" font-size="12" font-weight="600" fill="#64748b" font-family="Liberation Sans, Arial, sans-serif">DATALOADER</text>
            <text x="630" y="90" text-anchor="middle" font-size="12" font-weight="600" fill="#64748b" font-family="Liberation Sans, Arial, sans-serif">DATABASE</text>
            <text x="850" y="90" text-anchor="middle" font-size="12" font-weight="600" fill="#64748b" font-family="Liberation Sans, Arial, sans-serif">RESPONSE</text>

            <!-- Vertical dividers -->
            <line x1="250" y1="75" x2="250" y2="480" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
            <line x1="510" y1="75" x2="510" y2="480" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
            <line x1="750" y1="75" x2="750" y2="480" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>

            <!-- Step 1: Resolvers request data independently -->
            <g transform="translate(30, 110)">
                <!-- Resolver boxes -->
                <rect x="0" y="0" width="180" height="45" rx="6" fill="url(#resolverGradient)" filter="url(#shadow)"/>
                <text x="90" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">Resolver: User #1</text>
                <text x="90" y="35" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.8)" font-family="Liberation Sans, Arial, sans-serif">loader.load(1)</text>

                <rect x="0" y="60" width="180" height="45" rx="6" fill="url(#resolverGradient)" filter="url(#shadow)"/>
                <text x="90" y="80" text-anchor="middle" font-size="11" fill="white" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">Resolver: User #2</text>
                <text x="90" y="95" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.8)" font-family="Liberation Sans, Arial, sans-serif">loader.load(2)</text>

                <rect x="0" y="120" width="180" height="45" rx="6" fill="url(#resolverGradient)" filter="url(#shadow)"/>
                <text x="90" y="140" text-anchor="middle" font-size="11" fill="white" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">Resolver: User #3</text>
                <text x="90" y="155" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.8)" font-family="Liberation Sans, Arial, sans-serif">loader.load(3)</text>
            </g>

            <!-- Step number badge 1 -->
            <circle cx="50" cy="107" r="12" fill="#f97316"/>
            <text x="50" y="111" text-anchor="middle" font-size="11" font-weight="600" fill="white" font-family="Liberation Sans, Arial, sans-serif">1</text>

            <!-- Arrows from resolvers to DataLoader queue -->
            <path d="M215 135 L280 200" stroke="#f97316" stroke-width="2" marker-end="url(#arrowhead)" fill="none"/>
            <path d="M215 190 L280 210" stroke="#f97316" stroke-width="2" marker-end="url(#arrowhead)" fill="none"/>
            <path d="M215 250 L280 220" stroke="#f97316" stroke-width="2" marker-end="url(#arrowhead)" fill="none"/>

            <!-- Step 2: DataLoader collects keys -->
            <g transform="translate(270, 150)">
                <rect x="0" y="0" width="220" height="120" rx="8" fill="url(#loaderGradient)" filter="url(#shadow)"/>
                <text x="110" y="25" text-anchor="middle" font-size="13" fill="white" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">DataLoader Queue</text>
                <text x="110" y="45" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.7)" font-family="Liberation Sans, Arial, sans-serif">Collecting during event loop tick</text>

                <!-- Queue visualization -->
                <rect x="25" y="55" width="170" height="50" rx="4" fill="rgba(255,255,255,0.2)"/>
                <rect x="35" y="65" width="45" height="30" rx="3" fill="rgba(255,255,255,0.9)"/>
                <text x="57" y="85" text-anchor="middle" font-size="12" fill="#7c3aed" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">ID: 1</text>

                <rect x="87" y="65" width="45" height="30" rx="3" fill="rgba(255,255,255,0.9)"/>
                <text x="110" y="85" text-anchor="middle" font-size="12" fill="#7c3aed" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">ID: 2</text>

                <rect x="140" y="65" width="45" height="30" rx="3" fill="rgba(255,255,255,0.9)"/>
                <text x="163" y="85" text-anchor="middle" font-size="12" fill="#7c3aed" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">ID: 3</text>
            </g>

            <!-- Step number badge 2 -->
            <circle cx="290" cy="147" r="12" fill="#8b5cf6"/>
            <text x="290" y="151" text-anchor="middle" font-size="11" font-weight="600" fill="white" font-family="Liberation Sans, Arial, sans-serif">2</text>

            <!-- Arrow to database -->
            <path d="M495 210 L545 210" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowheadPurple)" fill="none"/>

            <!-- Step 3: Single batched query -->
            <g transform="translate(555, 150)">
                <rect x="0" y="0" width="180" height="120" rx="8" fill="url(#dbGradient)" filter="url(#shadow)"/>
                <text x="90" y="25" text-anchor="middle" font-size="13" fill="white" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">Database</text>
                <text x="90" y="45" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.7)" font-family="Liberation Sans, Arial, sans-serif">Single batched query</text>

                <!-- SQL representation -->
                <rect x="15" y="55" width="150" height="50" rx="4" fill="rgba(0,0,0,0.2)"/>
                <text x="90" y="75" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.9)" font-family="Liberation Sans, Arial, sans-serif">SELECT * FROM users</text>
                <text x="90" y="90" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.9)" font-family="Liberation Sans, Arial, sans-serif">WHERE id IN (1,2,3)</text>
            </g>

            <!-- Step number badge 3 -->
            <circle cx="575" cy="147" r="12" fill="#3b82f6"/>
            <text x="575" y="151" text-anchor="middle" font-size="11" font-weight="600" fill="white" font-family="Liberation Sans, Arial, sans-serif">3</text>

            <!-- Arrow from database to results -->
            <path d="M740 210 L770 210" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowheadBlue)" fill="none"/>

            <!-- Return arrows to resolvers (single path with branch to all three) -->
            <!-- Main return path from Results Map, going below the flow -->
            <path d="M780 210 L760 210 L760 295 L20 295 L20 190" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3" fill="none"/>
            <!-- Branch arrows to each resolver -->
            <path d="M20 190 L20 133 L30 133" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowheadGreen)" fill="none"/>
            <path d="M20 190 L30 190" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowheadGreen)" fill="none"/>
            <path d="M20 250 L30 250" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowheadGreen)" fill="none"/>
            <path d="M20 190 L20 250" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3" fill="none"/>
            <!-- Small label for the return flow -->
            <text x="400" y="290" text-anchor="middle" font-size="10" fill="#10b981" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">Results distributed to waiting resolvers</text>

            <!-- Step 4: Results distributed -->
            <g transform="translate(780, 130)">
                <rect x="0" y="0" width="140" height="160" rx="8" fill="url(#successGradient)" filter="url(#shadow)"/>
                <text x="70" y="25" text-anchor="middle" font-size="12" fill="white" font-weight="600" font-family="Liberation Sans, Arial, sans-serif">Results Map</text>

                <!-- Results -->
                <rect x="15" y="40" width="110" height="30" rx="4" fill="rgba(255,255,255,0.2)"/>
                <text x="70" y="60" text-anchor="middle" font-size="10" fill="white" font-family="Liberation Sans, Arial, sans-serif">1 → User{...}</text>

                <rect x="15" y="75" width="110" height="30" rx="4" fill="rgba(255,255,255,0.2)"/>
                <text x="70" y="95" text-anchor="middle" font-size="10" fill="white" font-family="Liberation Sans, Arial, sans-serif">2 → User{...}</text>

                <rect x="15" y="110" width="110" height="30" rx="4" fill="rgba(255,255,255,0.2)"/>
                <text x="70" y="130" text-anchor="middle" font-size="10" fill="white" font-family="Liberation Sans, Arial, sans-serif">3 → User{...}</text>
            </g>

            <!-- Step number badge 4 -->
            <circle cx="800" cy="127" r="12" fill="#10b981"/>
            <text x="800" y="131" text-anchor="middle" font-size="11" font-weight="600" fill="white" font-family="Liberation Sans, Arial, sans-serif">4</text>

            <!-- Comparison box: Without vs With DataLoader -->
            <g transform="translate(50, 320)">
                <!-- Without DataLoader -->
                <rect x="0" y="0" width="400" height="140" rx="8" fill="#fff1f2" stroke="#fecdd3" stroke-width="2"/>
                <text x="200" y="25" text-anchor="middle" font-size="13" font-weight="600" fill="#be123c" font-family="Liberation Sans, Arial, sans-serif">Without DataLoader (N+1 Problem)</text>

                <!-- Multiple queries visualization -->
                <rect x="20" y="45" width="360" height="80" rx="4" fill="#fecdd3"/>
                <text x="200" y="65" text-anchor="middle" font-size="10" fill="#9f1239" font-family="Liberation Sans, Arial, sans-serif">SELECT * FROM users WHERE id = 1</text>
                <text x="200" y="80" text-anchor="middle" font-size="10" fill="#9f1239" font-family="Liberation Sans, Arial, sans-serif">SELECT * FROM users WHERE id = 2</text>
                <text x="200" y="95" text-anchor="middle" font-size="10" fill="#9f1239" font-family="Liberation Sans, Arial, sans-serif">SELECT * FROM users WHERE id = 3</text>
                <text x="200" y="115" text-anchor="middle" font-size="11" fill="#9f1239" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">... N queries for N items!</text>
            </g>

            <g transform="translate(500, 320)">
                <!-- With DataLoader -->
                <rect x="0" y="0" width="400" height="140" rx="8" fill="#ecfdf5" stroke="#a7f3d0" stroke-width="2"/>
                <text x="200" y="25" text-anchor="middle" font-size="13" font-weight="600" fill="#059669" font-family="Liberation Sans, Arial, sans-serif">With DataLoader (Batched)</text>

                <!-- Single query visualization -->
                <rect x="20" y="45" width="360" height="80" rx="4" fill="#a7f3d0"/>
                <text x="200" y="75" text-anchor="middle" font-size="10" fill="#047857" font-family="Liberation Sans, Arial, sans-serif">SELECT * FROM users</text>
                <text x="200" y="95" text-anchor="middle" font-size="10" fill="#047857" font-family="Liberation Sans, Arial, sans-serif">WHERE id = ANY([1, 2, 3])</text>
                <text x="200" y="115" text-anchor="middle" font-size="11" fill="#047857" font-weight="500" font-family="Liberation Sans, Arial, sans-serif">1 query regardless of N!</text>
            </g>

            <!-- Bottom annotation -->
            <text x="475" y="510" text-anchor="middle" font-size="11" fill="#64748b" font-style="italic" font-family="Liberation Sans, Arial, sans-serif">
                DataLoader must be instantiated per-request to prevent cache pollution across users
            </text>
        </svg>
    </div>
</body>
</html>
